---
phase: 03-text-processing
plan: 04
type: execute
wave: 2
depends_on: [03-01, 03-02]
files_modified:
  - src/text_processor_enhanced.py
  - src/proper_nouns.py
  - src/data/cities.json
  - src/data/names.json
  - src/data/countries.json
autonomous: true

must_haves:
  truths:
    - "Proper noun dictionary contains 500-1000 entries (cities, names, countries)"
    - "Cities loaded from external dataset or generated list"
    - "Common Russian names included (Denis, Сергей, Александр, etc.)"
    - "Countries included in Russian form (Россия, США, Франция, etc.)"
    - "Proper nouns capitalized correctly in processed text"
  artifacts:
    - path: "src/proper_nouns.py"
      provides: "Proper noun recognition and capitalization module"
      min_lines: 80
      exports: ["ProperNounDict", "capitalize_known"]
    - path: "src/data/cities.json"
      provides: "Russian cities dictionary"
      min_lines: 50
    - path: "src/data/names.json"
      provides: "Common Russian names dictionary"
      min_lines: 50
    - path: "src/data/countries.json"
      provides: "Countries in Russian"
      min_lines: 20
  key_links:
    - from: "src/text_processor_enhanced.py"
      to: "src/proper_nouns.py"
      via: "import ProperNounDict"
      pattern: "from \.proper_nouns import|proper_nouns\.ProperNounDict"
    - from: "src/proper_nouns.py"
      to: "src/data/*.json"
      via: "load_json() method"
      pattern: "\.json"
---

# Plan: Create proper noun dictionary

## Objective

Create proper noun dictionary with 500-1000 entries covering Russian cities, common names, and countries. Addresses POST-04 requirement for proper noun recognition and capitalization.

**Purpose:** ASR outputs proper nouns in lowercase ("москва", "деннис", "россия"). Capitalization of known entities improves readability and correctness. Dictionary-based approach is fast and accurate for common cases.

**Output:** New `src/proper_nouns.py` module with `ProperNounDict` class, JSON data files with 500-1000 entries, integrated into `EnhancedTextProcessor`.

## Context

@.planning/phases/03-text-processing/03-CONTEXT.md
@.planning/phases/03-text-processing/03-RESEARCH.md
@src/text_processor_enhanced.py

Research findings:
- Target: 500-1000 entries (not 1000-5000 as ROADMAP says - CONTEXT clarifies MVP scope)
- Categories: cities (200-500), names (200-400), countries (50-100)
- Source: epogrebnyak/ru-cities for cities, manual lists for names/countries
- Load at startup (static, no runtime API calls)
- Lowercase lookup set for O(1) matching

Dependencies:
- 03-01: Expanded correction rules (foundation)
- 03-02: Phonetic corrections (runs before proper nouns)

## Tasks

<task type="auto">
  <name>Task 1: Create data directory and cities.json</name>
  <files>src/data/cities.json, src/data/__init__.py</files>
  <action>
    1. Create src/data/ directory
    2. Create src/data/__init__.py (empty)
    3. Create src/data/cities.json with 200-300 Russian cities

    Cities to include (top by population + regional capitals):
    - Major cities: Москва, Санкт-Петербург, Новосибирск, Екатеринбург, Казань, Нижний Новгород, Челябинск, Самара, Омск, Ростов-на-Дону
    - Regional capitals: Владивосток, Хабаровск, Красноярск, Иркутск, Сочи, Калининград, Мурманск, Архангельск, Воронеж, Саратов
    - Additional cities to reach 200-300 entries

    JSON format:
    ```json
    [
        {"name": "Москва", "variants": ["москва", "moscow"]},
        {"name": "Санкт-Петербург", "variants": ["санкт-петербург", "санкт петербург", "петербург", "ленинград"]},
        {"name": "Казань", "variants": ["казань"]},
        ...
    ]
    ```

    Include alternative names and common misspellings.
  </action>
  <verify>cities.json exists with 200+ city entries</verify>
  <done>City dictionary created with major Russian cities</done>
</task>

<task type="auto">
  <name>Task 2: Create names.json and countries.json</name>
  <files>src/data/names.json, src/data/countries.json</files>
  <action>
    1. Create src/data/names.json with 200-400 common Russian names

    Names categories:
    - Male: Александр, Алексей, Андрей, Дмитрий, Сергей, Максим, Артём, Михаил, Иван, Владимир, etc.
    - Female: Елена, Ольга, Татьяна, Наталья, Екатерина, Анна, Мария, Светлана, Юлия, Ирина, etc.
    - Transliterated: Denis, Nikita, Vladimir, Anna, etc.

    JSON format:
    ```json
    [
        {"name": "Александр", "variants": ["александр", "саша", "саня"]},
        {"name": "Елена", "variants": ["елена", "лена"]},
        {"name": "Denis", "variants": ["деннис", "дэннис", "денис"]},
        ...
    ]
    ```

    2. Create src/data/countries.json with 50-100 countries

    Countries to include (Russian names):
    - Россия, США, Китай, Германия, Франция, Италия, Испания, Великобритания, Япония, Канада
    - Украина, Беларусь, Казахстан, Узбекистан, Польша, Чехия, Турция, Индия, Бразилия, Аргентина
    - And 40+ more

    JSON format:
    ```json
    [
        {"name": "Россия", "variants": ["россия", "рф"]},
        {"name": "США", "variants": ["сша", "североамериканские штаты"]},
        {"name": "Германия", "variants": ["германия"]},
        ...
    ]
    ```
  </action>
  <verify>names.json has 200+ entries, countries.json has 50+ entries</verify>
  <done>Name and country dictionaries created</done>
</task>

<task type="auto">
  <name>Task 3: Create proper_nouns.py module</name>
  <files>src/proper_nouns.py</files>
  <action>
    Create src/proper_nouns.py with ProperNounDict class:

    ```python
    """Proper noun recognition and capitalization."""
    import json
    import re
    from pathlib import Path
    from typing import Set, Dict, List

    class ProperNounDict:
        """Load and manage proper noun dictionaries."""

        def __init__(self, data_dir: str = None):
            if data_dir is None:
                data_dir = Path(__file__).parent / "data"
            else:
                data_dir = Path(data_dir)

            self._lookup: Set[str] = set()
            self._variants: Dict[str, str] = {}  # variant -> canonical

            self._load_cities(data_dir / "cities.json")
            self._load_names(data_dir / "names.json")
            self._load_countries(data_dir / "countries.json")

        def _load_json(self, path: Path) -> List[Dict]:
            """Load JSON file or return empty list."""
            if path.exists():
                with open(path, 'r', encoding='utf-8') as f:
                    return json.load(f)
            return []

        def _load_cities(self, path: Path):
            """Load cities from JSON."""
            for entry in self._load_json(path):
                name = entry.get("name", "")
                variants = entry.get("variants", [])

                self._lookup.add(name.lower())
                for variant in variants:
                    self._lookup.add(variant.lower())
                    if variant.lower() != name.lower():
                        self._variants[variant.lower()] = name

        def _load_names(self, path: Path):
            """Load names from JSON."""
            # Similar pattern
            pass

        def _load_countries(self, path: Path):
            """Load countries from JSON."""
            # Similar pattern
            pass

        def is_proper_noun(self, word: str) -> bool:
            """Check if word is a known proper noun."""
            return word.lower() in self._lookup

        def get_canonical(self, word: str) -> str:
            """Get canonical form of proper noun."""
            lower = word.lower()
            if lower in self._variants:
                return self._variants[lower].capitalize()
            return word.capitalize()

        def capitalize_known(self, text: str) -> str:
            """Capitalize known proper nouns in text."""
            words = text.split()
            for i, word in enumerate(words):
                # Remove punctuation for checking
                clean = re.sub(r'[^\w]', '', word)
                if self.is_proper_noun(clean):
                    # Capitalize preserving punctuation
                    if clean and word:
                        words[i] = word[:len(clean)].capitalize() + word[len(clean):]
            return ' '.join(words)
    ```

    Handle missing files gracefully (empty dictionaries if JSON not found).
  </action>
  <verify>ProperNounDict class loads all dictionaries and provides capitalize_known()</verify>
  <done>Proper nouns module created with dictionary loading</done>
</task>

<task type="auto">
  <name>Task 4: Integrate proper nouns into EnhancedTextProcessor</name>
  <files>src/text_processor_enhanced.py</files>
  <action>
    Import and use ProperNounDict in EnhancedTextProcessor:

    1. Add import: from .proper_nouns import ProperNounDict
    2. In __init__:
       - self.proper_nouns = ProperNounDict()
    3. In process() method:
       - Add proper noun capitalization AFTER punctuation restoration
       - text = self.proper_nouns.capitalize_known(text)

    Processing order:
    1. Fix common errors (_fix_errors)
    2. Phonetic corrections
    3. Morphology corrections
    4. Add punctuation
    5. Fix punctuation placement
    6. Fix capitalization (general)
    7. Proper noun capitalization (NEW)
    8. Final cleanup

    Ensure proper nouns don't get over-capitalized (only capitalize known entities).
  </action>
  <verify>EnhancedTextProcessor uses ProperNounDict for capitalization</verify>
  <done>Proper noun capitalization integrated into processing pipeline</done>
</task>

## Verification

1. Module test: `from src.proper_nouns import ProperNounDict`
2. Load test: All JSON files load without errors
3. Count test: Total entries >= 500
4. Capitalization test: "москва" -> "Москва", "деннис" -> "Denis"
5. Integration test: EnhancedTextProcessor capitalizes known entities

## Success Criteria

- [ ] 500-1000 total entries across all dictionaries
- [ ] Cities: 200-300 entries
- [ ] Names: 200-400 entries
- [ ] Countries: 50-100 entries
- [ ] ProperNounDict loads all dictionaries on init
- [ ] capitalize_known() method works correctly
- [ ] Integration with EnhancedTextProcessor

## Output

After completion, create `.planning/phases/03-text-processing/03-04-SUMMARY.md` with:
- Total entry count by category
- Sample cities, names, countries included
- Capitalization examples
