---
phase: 03-text-processing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/text_processor_enhanced.py
autonomous: true

must_haves:
  truths:
    - "EnhancedTextProcessor contains 100+ correction rules for Russian language"
    - "New rules cover common ASR errors (homophones, dropped letters, wrong endings)"
    - "All existing 50+ rules are preserved and functional"
    - "Rules are sorted by length (longest first) for proper matching"
    - "Regex patterns are pre-compiled for performance"
  artifacts:
    - path: "src/text_processor_enhanced.py"
      provides: "Extended correction rules (100+ entries)"
      min_lines: 350
      contains: "self.corrections = {"
  key_links:
    - from: "src/text_processor_enhanced.py"
      to: "self._load_corrections()"
      via: "_russian_corrections() method"
      pattern: "def _russian_corrections"
---

# Plan: Expand EnhancedTextProcessor from 50 to 100+ correction rules

## Objective

Expand EnhancedTextProcessor from current ~50 correction rules to 100+ rules for Russian language ASR errors. This addresses POST-01 requirement and provides foundation for phonetic and morphological corrections in subsequent plans.

**Purpose:** Sherpa-ONNX and Whisper produce systematic errors in Russian text post-processing. Current 50 rules cover basic cases but miss many common ASR mistakes. Expanding to 100+ rules improves CER by 5-10%.

**Output:** EnhancedTextProcessor with 100+ correction rules, covering homophones, dropped letters, wrong endings, preposition errors, and common verb/adjective mistakes.

## Context

@.planning/phases/03-text-processing/03-CONTEXT.md
@.planning/phases/03-text-processing/03-RESEARCH.md
@src/text_processor_enhanced.py

Current state: ~50 rules in `_russian_corrections()` method. Rules are stored in `self.corrections` dict and compiled to regex patterns. Pattern-based corrections in `self.pattern_corrections` list.

## Tasks

<task type="auto">
  <name>Task 1: Analyze existing rules and identify gaps</name>
  <files>src/text_processor_enhanced.py</files>
  <action>
    Read current _russian_corrections() method. Count existing rules. Categorize by type:
    - Phonetic substitutions (лыбки -> улыбки)
    - Verb endings (станек -> станет)
    - Prepositions (неверо -> небе)
    - Adjectives (сидлей -> светлей)
    - Double letters/words

    Identify gaps: common Russian ASR errors not covered.
  </action>
  <verify>Count current rules, document categories, list gap areas</verify>
  <done>Gap analysis complete with list of missing rule categories</done>
</task>

<task type="auto">
  <name>Task 2: Add 50+ new correction rules covering common ASR errors</name>
  <files>src/text_processor_enhanced.py</files>
  <action>
    Add 50+ new rules to self.corrections dict in _russian_corrections() method.
    Cover these categories (NOT overlapping with 03-02 phonetic focus):

    1. Dropped letters (ASR skips similar-sounding letters):
       - "привет" -> "привет" (missing т)
       - "спасибо" -> "спасибо" (missing б)
       - "здравствуйте" -> "здравствуйте" (missing в)

    2. Common preposition errors:
       - "на" -> "не" context errors
       - "в" -> "во" variations
       - "с" -> "со" before certain consonants
       - "к" -> "ко" variations

    3. Common verb ending mistakes:
       - -т/-ть confusion (делает -> делать)
       - -ся/-сь variations
       - Past tense gender mismatches

    4. Common adjective-noun mismatches (basic ones):
       - "хороший день" -> "хороший день" (already correct)
       - "красивая машина" -> "красивая машина" (already correct)
       - Add REAL mistakes like "большой семья" -> "большая семья"

    5. Common conjunction errors:
       - "и" -> "е" visual errors
       - "а" -> "о" confusion
       - "но" -> "не" errors

    6. Number word errors:
       - "один" -> "одно" variations
       - "два" -> "две" gender mismatches
       - "три" -> "трие" errors

    7. Common pronoun errors:
       - "он" -> "она" context mismatches
       - "мой" -> "моя" agreement errors
       - "его" -> "её" confusion

    DO NOT overlap with 03-02 (phonetic б↔п pairs). Focus on:
    - Dropped letters
    - Preposition/conjunction errors
    - Basic gender agreement
    - Number/pronoun errors
    - Common ASR substitutions

    Keep existing rules. Add new ones after existing entries.
  </action>
  <verify>len(self.corrections) >= 100 after changes</verify>
  <done>100+ correction rules in self.corrections dict</done>
</task>

<task type="auto">
  <name>Task 3: Add regex patterns for multi-word corrections</name>
  <files>src/text_processor_enhanced.py</files>
  <action>
    Add 5-10 new regex patterns to self.pattern_corrections list.
    Focus on multi-word sequences not covered by dict replacements:

    1. "еще раз" -> "ещё раз" (ё normalization)
    2. "все таки" -> "всё-таки" (hyphenation)
    3. "во вообще" -> "вообще" (extra preposition)
    4. "не который" -> "некоторый" (space errors)
    5. "как бы" -> "как бы" (missing space variations)
    6. "так же" -> "также" (compound word)

    Use both simple string replacement and lambda functions for context-sensitive fixes.
  </action>
  <verify>len(self.pattern_corrections) >= 15 (existing ~10 + new 5+)</verify>
  <done>Regex patterns for multi-word error corrections added</done>
</task>

## Verification

1. Count rules: `len(processor.corrections) >= 100`
2. Verify pre-compilation: `_compile_patterns()` generates correct regex
3. Test with sample Russian text containing common errors
4. Confirm no breaking changes to existing API

## Success Criteria

- [ ] EnhancedTextProcessor has 100+ correction rules
- [ ] New rules cover dropped letters, prepositions, verbs, adjectives
- [ ] Regex patterns handle multi-word errors
- [ ] All existing rules preserved (no regressions)
- [ ] Pre-compilation works for expanded rule set

## Output

After completion, create `.planning/phases/03-text-processing/03-01-SUMMARY.md` with:
- Total rule count
- New rule categories added
- Sample corrections applied
- Any edge cases discovered
