---
phase: 03-text-processing
plan: 06
type: execute
wave: 3
depends_on: [03-01, 03-02, 03-03, 03-04, 03-05]
files_modified:
  - src/text_processor_enhanced.py
  - src/backends/base.py
autonomous: true

must_haves:
  truths:
    - "Post-processing pipeline adapts to backend type (whisper vs sherpa)"
    - "Whisper text skips punctuation restoration (already has it)"
    - "Sherpa/Podlodka text gets full punctuation restoration"
    - "All backends get corrections and capitalization"
  artifacts:
    - path: "src/text_processor_enhanced.py"
      provides: "Backend-aware text processing"
      contains: "backend"
      min_lines: 350
    - path: "src/backends/base.py"
      provides: "Backend type property for detection"
      contains: "backend_name"
  key_links:
    - from: "src/backends/whisper_backend.py"
      to: "src/text_processor_enhanced.py"
      via: "processor.backend='whisper'"
      pattern: "backend.*whisper"
    - from: "src/backends/sherpa_backend.py"
      to: "src/text_processor_enhanced.py"
      via: "processor.backend='sherpa'"
      pattern: "backend.*sherpa"
---

# Plan: Implement adaptive post-processing for Whisper vs Sherpa

## Objective

Implement adaptive post-processing pipeline that adjusts behavior based on backend type. Addresses POST-07 requirement for backend-aware processing.

**Purpose:** Whisper already provides punctuation in output, while Sherpa-ONNX produces raw lowercase text without punctuation. Applying full punctuation restoration to Whisper text creates double punctuation or breaks existing formatting. Adaptive pipeline optimizes for each backend.

**Output:** EnhancedTextProcessor with `backend` parameter, different processing pipelines for Whisper vs Sherpa/Podlodka, backend detection integration.

## Context

@.planning/phases/03-text-processing/03-CONTEXT.md
@.planning/phases/03-text-processing/03-RESEARCH.md
@src/text_processor_enhanced.py
@src/backends/base.py
@src/backends/whisper_backend.py
@src/backends/sherpa_backend.py

Research findings:
- Whisper: Has punctuation, fewer morphology errors, needs light processing
- Sherpa: No punctuation, all lowercase, heavy morphology errors, needs full processing
- Podlodka: Similar to Sherpa (no punctuation)
- Explicit backend parameter preferred over auto-detection

Dependencies:
- 03-01, 03-02, 03-03: All corrections must be in place
- 03-04: Proper nouns must be integrated
- 03-05: Capitalization must be final step

## Tasks

<task type="auto">
  <name>Task 1: Analyze backend classes and current text processor usage</name>
  <files>src/backends/base.py, src/backends/whisper_backend.py, src/backends/sherpa_backend.py</files>
  <action>
    Read backend files to understand:
    1. Base backend structure (BaseBackend class)
    2. How each backend creates/uses EnhancedTextProcessor
    3. Backend identification (is there a name/type property?)
    4. Where text post-processing is called

    Identify:
    - How to detect backend type (add property if missing)
    - Where to pass backend parameter to EnhancedTextProcessor
    - Current differences in how backends use text processor
  </action>
  <verify>Backend structure documented, integration points identified</verify>
  <done>Backend analysis complete with integration plan</done>
</task>

<task type="auto">
  <name>Task 2: Add backend parameter to EnhancedTextProcessor</name>
  <files>src/text_processor_enhanced.py</files>
  <action>
    Modify EnhancedTextProcessor to accept backend parameter:

    1. Update __init__ signature:
       ```python
       def __init__(self, language: str = "ru", enable_corrections: bool = True,
                    enable_punctuation: bool = True, backend: str = "sherpa"):
       ```

    2. Store backend and set flags:
       ```python
       self.backend = backend.lower()
       self._configure_for_backend()
       ```

    3. Add _configure_for_backend() method:
       ```python
       def _configure_for_backend(self):
           """Configure processing based on backend type."""
           if self.backend == "whisper":
               # Whisper has punctuation, needs minimal processing
               self.enable_punctuation = False  # Don't add punctuation
               self.enable_morphology = False   # Fewer errors
               self.enable_phonetics = False    # Fewer phonetic errors
           else:
               # Sherpa, Podlodka: no punctuation, full processing
               self.enable_punctuation = True
               self.enable_morphology = True
               self.enable_phonetics = True
       ```

    4. Modify process() to use flags:
       ```python
       def process(self, text: str) -> str:
           if not text or not self.enable_corrections:
               return text

           # Step 1: Fix common errors (all backends)
           text = self._fix_errors(text)

           # Step 2: Phonetic corrections (Sherpa only)
           if self.enable_phonetics and hasattr(self, 'phonetic_corrector'):
               text = self.phonetic_corrector.process(text)

           # Step 3: Morphology corrections (Sherpa only)
           if self.enable_morphology and hasattr(self, 'morphology_corrector'):
               text = self._fix_morphology(text)

           # Step 4: Add punctuation (Sherpa only)
           if self.enable_punctuation:
               text = self._add_punctuation(text)

           # Step 5: Fix punctuation placement (all backends)
           text = self._fix_punctuation(text)

           # Step 6: Fix capitalization (all backends)
           text = self._fix_capitalization(text)

           # Step 7: Proper nouns (all backends)
           if hasattr(self, 'proper_nouns'):
               text = self.proper_nouns.capitalize_known(text)

           # Step 8: Final cleanup (all backends)
           text = self._cleanup(text)

           return text
       ```
  </action>
  <verify>EnhancedTextProcessor accepts backend parameter and adjusts processing</verify>
  <done>Backend parameter added with adaptive processing logic</done>
</task>

<task type="auto">
  <name>Task 3: Add backend name property to BaseBackend</name>
  <files>src/backends/base.py</files>
  <action>
    Add backend_name property to BaseBackend if not present:

    ```python
    @property
    def backend_name(self) -> str:
        """Return backend identifier for text processor configuration."""
        return self.__class__.__name__.replace("Backend", "").lower()
    ```

    This allows each backend to report its type without hardcoded strings.
    WhisperBackend -> "whisper"
    SherpaBackend -> "sherpa"
    PodlodkaTurboBackend -> "podlodka" or "podlodkaturbo"

    Check if property exists, add if missing.
  </action>
  <verify>BaseBackend has backend_name property</verify>
  <done>Backend identification property added</done>
</task>

<task type="auto">
  <name>Task 4: Update backends to pass backend parameter</name>
  <files>src/backends/whisper_backend.py, src/backends/sherpa_backend.py, src/backends/podlodka_turbo_backend.py</files>
  <action>
    Update each backend to pass backend parameter to EnhancedTextProcessor:

    For each backend (whisper_backend.py, sherpa_backend.py, podlodka_turbo_backend.py):

    1. Find where EnhancedTextProcessor is instantiated
    2. Add backend parameter:
       ```python
       # Before:
       self.text_processor = EnhancedTextProcessor(language="ru")

       # After:
       self.text_processor = EnhancedTextProcessor(
           language="ru",
           backend=self.backend_name
       )
       ```

    If backends don't use EnhancedTextProcessor, add it following
    the pattern from sherpa_backend.py (which should already have it).
  </action>
  <verify>All backends pass backend_name to EnhancedTextProcessor</verify>
  <done>Backend integration complete with adaptive processing</done>
</task>

## Verification

1. Whisper mode: Punctuation restoration skipped, only light corrections
2. Sherpa mode: Full processing including punctuation
3. Backend detection: Each backend correctly identifies itself
4. Integration: All backends use EnhancedTextProcessor with backend parameter

## Success Criteria

- [ ] EnhancedTextProcessor accepts backend parameter
- [ ] Whisper pipeline skips punctuation restoration
- [ ] Sherpa/Podlodka pipeline includes full processing
- [ ] BaseBackend has backend_name property
- [ ] All backends pass backend to text processor
- [ ] No double punctuation in Whisper output

## Output

After completion, create `.planning/phases/03-text-processing/03-06-SUMMARY.md` with:
- Backend detection approach
- Processing pipeline differences (Whisper vs Sherpa)
- Integration points updated
- Sample outputs showing adaptive behavior
