---
phase: 03-text-processing
plan: 03
type: execute
wave: 2
depends_on: [03-01, 03-02]
files_modified:
  - src/text_processor_enhanced.py
  - src/morphology.py
autonomous: true

must_haves:
  truths:
    - "Morphological corrections fix gender agreement (adjective-noun mismatches)"
    - "Case corrections fix common noun ending errors (стола -> стол)"
    - "pymorphy2 integration with singleton pattern for performance"
    - "Corrections limited to high-confidence cases (score > 0.5)"
  artifacts:
    - path: "src/morphology.py"
      provides: "Morphological correction module using pymorphy2"
      min_lines: 100
      exports: ["MorphologyCorrector", "fix_gender_agreement", "fix_case_endings"]
    - path: "src/text_processor_enhanced.py"
      provides: "Integration with morphological corrections"
      contains: "from .morphology import"
  key_links:
    - from: "src/text_processor_enhanced.py"
      to: "src/morphology.py"
      via: "import MorphologyCorrector"
      pattern: "from \.morphology import|morphology\.MorphologyCorrector"
    - from: "src/morphology.py"
      to: "pymorphy2"
      via: "import pymorphy2"
      pattern: "import pymorphy2|MorphAnalyzer"
---

# Plan: Add morphological corrections using pymorphy2

## Objective

Implement morphological corrections for Russian language using pymorphy2 library. Addresses POST-03 requirement for gender agreement and case ending corrections.

**Purpose:** Sherpa-ONNX produces morphology errors like "огромный семья" (wrong gender) and "стола" instead of "стол" (wrong case). pymorphy2 provides accurate Russian morphology analysis. Fixing high-confidence cases improves CER by 2-4%.

**Output:** New `src/morphology.py` module with `MorphologyCorrector` class, integrated into `EnhancedTextProcessor`. Uses singleton pattern for pymorphy2 to avoid performance issues.

## Context

@.planning/phases/03-text-processing/03-CONTEXT.md
@.planning/phases/03-text-processing/03-RESEARCH.md
@src/text_processor_enhanced.py

Research findings:
- Use pymorphy2 (NOT natasha - too heavy for morphology-only)
- Focus on gender agreement (adjective-noun) and basic case corrections
- Limit to high-confidence cases (pymorphy2 score > 0.5)
- DO NOT do full verb conjugation (too complex for Phase 3)
- Singleton pattern: one MorphAnalyzer instance, not per-call

Dependencies:
- 03-01: Expanded correction rules (provides foundation)
- 03-02: Phonetic corrections (runs before morphology to clean text first)

## Tasks

<task type="auto">
  <name>Task 1: Create morphology module with pymorphy2 integration</name>
  <files>src/morphology.py</files>
  <action>
    Create new src/morphology.py with:

    1. Import pymorphy2 (optional - try/except ImportError):
       ```python
       try:
           import pymorphy2
           PYMORPHY2_AVAILABLE = True
       except ImportError:
           PYMORPHY2_AVAILABLE = False
       ```

    2. MorphologyCorrector class with:
       - _morph: Class-level singleton MorphAnalyzer
       - __init__(self): Initialize _morph if not exists
       - _parse_word(self, word: str): Parse word with caching
       - fix_gender_agreement(self, text: str) -> str
       - fix_case_endings(self, text: str) -> str
       - process(self, text: str) -> str

    Singleton pattern:
    ```python
    class MorphologyCorrector:
        _morph = None

        def __init__(self):
            if PYMORPHY2_AVAILABLE and MorphologyCorrector._morph is None:
                MorphologyCorrector._morph = pymorphy2.MorphAnalyzer()
            self._cache = {}  # Word-level cache
    ```

    Make module gracefully degrade if pymorphy2 not installed.
  </action>
  <verify>File exists with MorphologyCorrector class and singleton pattern</verify>
  <done>Morphology module created with pymorphy2 integration</done>
</task>

<task type="auto">
  <name>Task 2: Implement gender agreement correction</name>
  <files>src/morphology.py</files>
  <action>
    Implement fix_gender_agreement() method:

    Logic:
    1. Split text into tokens
    2. For each adjacent word pair (word1, word2):
       - Parse both with pymorphy2
       - Check if word1.tag.POS == 'ADJF' (adjective) and word2.tag.POS == 'NOUN'
       - If gender mismatch (word1.tag.gender != word2.tag.gender):
         * Try to inflect word1 to match word2's gender
         * Apply correction ONLY if both have high confidence (score > 0.5)

    Example corrections:
    - "огромный семья" -> "огромная семья" (masc -> fem)
    - "мое родной" -> "мое родное" (neut -> neut, wrong ending)
    - "большой проблема" -> "большая проблема" (masc -> fem)

    Implementation:
    ```python
    def fix_gender_agreement(self, text: str) -> str:
        words = text.split()
        for i in range(len(words) - 1):
            word1, word2 = words[i], words[i + 1]

            p1 = self._parse_word(word1)
            p2 = self._parse_word(word2)

            if not p1 or not p2:
                continue

            # Check confidence
            if p1[0].score <= 0.5 or p2[0].score <= 0.5:
                continue

            # Adjective + noun with gender mismatch
            if (p1[0].tag.POS == 'ADJF' and
                p2[0].tag.POS == 'NOUN' and
                p1[0].tag.gender != p2[0].tag.gender):

                corrected = p1[0].inflect({p2[0].tag.gender})
                if corrected:
                    words[i] = corrected.word

        return ' '.join(words)
    ```

    DO NOT correct ambiguous cases (e.g., "мой друг" could be correct).
  </action>
  <verify>Method detects and fixes adjective-noun gender mismatches</verify>
  <done>Gender agreement correction implemented</done>
</task>

<task type="auto">
  <name>Task 3: Implement case ending correction</name>
  <files>src/morphology.py</files>
  <action>
    Implement fix_case_endings() method:

    Logic:
    1. Identify common case ending errors in Russian ASR:
       - Wrong accusative (стола -> стол)
       - Wrong genitive (года вместо год)
       - Wrong dative (мне -> мене - rare)
    2. For words with low confidence pymorphy2 parse:
       - Try alternative case inflections
       - Select most likely based on context (simplified: use highest score)

    Focus on common corrections:
    - "идту" -> "иду" (verb, but treated as ending error)
    - "стола" (as accusative of стол, not genitive of столы)
    - "года" -> "год" (in numerical contexts "мне 15 года" -> "мне 15 лет" is different correction)

    Simplified approach:
    ```python
    def fix_case_endings(self, text: str) -> str:
        words = text.split()
        for i, word in enumerate(words):
            parsed = self._parse_word(word)

            if not parsed or parsed[0].score > 0.5:
                continue  # Skip high-confidence words

            # Low confidence - try normal form
            normal = parsed[0].normal_form

            # Check if normal form is common and original is rare variant
            if normal != word and len(normal) <= len(word) + 2:
                # Use normal form if it fits context (simplified check)
                words[i] = normal

        return ' '.join(words)
    ```

    NOTE: Full case restoration requires context analysis (deferred to Phase 4).
    Phase 3 scope: basic ending corrections for low-confidence parses.
  </action>
  <verify>Method corrects basic case ending errors</verify>
  <done>Case ending correction implemented</done>
</task>

<task type="auto">
  <name>Task 4: Integrate morphology corrections into EnhancedTextProcessor</name>
  <files>src/text_processor_enhanced.py</files>
  <action>
    Import and use MorphologyCorrector in EnhancedTextProcessor:

    1. Add import: from .morphology import MorphologyCorrector
    2. In __init__:
       - self.morphology_corrector = MorphologyCorrector()
       - Set self.enable_morphology based on PYMORPHY2_AVAILABLE
    3. In process() method:
       - Add morphology step AFTER phonetic corrections
       - text = self._fix_morphology(text)

    Processing order:
    1. Fix common errors (_fix_errors)
    2. Phonetic corrections
    3. Morphology corrections (NEW)
    4. Add punctuation
    5. Fix punctuation placement
    6. Fix capitalization
    7. Final cleanup

    Create _fix_morphology() method:
    ```python
    def _fix_morphology(self, text: str) -> str:
        if not self.enable_morphology:
            return text

        # Gender agreement
        text = self.morphology_corrector.fix_gender_agreement(text)

        # Case endings
        text = self.morphology_corrector.fix_case_endings(text)

        return text
    ```

    Make morphology optional - skip if pymorphy2 not installed.
  </action>
  <verify>EnhancedTextProcessor uses MorphologyCorrector</verify>
  <done>Morphology corrections integrated into processing pipeline</done>
</task>

## Verification

1. Module test: `from src.morphology import MorphologyCorrector`
2. Gender test: "огромный семья" -> "огромная семья"
3. Case test: basic ending corrections work
4. Integration test: EnhancedTextProcessor applies morphology fixes
5. Performance test: no repeated MorphAnalyzer initialization

## Success Criteria

- [ ] MorphologyCorrector class with pymorphy2 integration
- [ ] Gender agreement correction for adjective-noun pairs
- [ ] Case ending correction for low-confidence parses
- [ ] Singleton pattern for MorphAnalyzer
- [ ] Integration with EnhancedTextProcessor
- [ ] Graceful degradation if pymorphy2 not installed

## Output

After completion, create `.planning/phases/03-text-processing/03-03-SUMMARY.md` with:
- pymorphy2 integration details
- Gender agreement patterns fixed
- Case correction approach
- Performance notes (caching, singleton)
