---
phase: 03-text-processing
plan: 05
type: execute
wave: 3
depends_on: [03-01, 03-02, 03-03, 03-04]
files_modified:
  - src/text_processor_enhanced.py
autonomous: true

must_haves:
  truths:
    - "Capitalization works after sentence-ending punctuation (., !, ?)"
    - "First letter of text always capitalized"
    - "Capitalization after abbreviations handled (optional but nice)"
    - "Proper nouns not affected (no over-capitalization)"
  artifacts:
    - path: "src/text_processor_enhanced.py"
      provides: "Improved capitalization logic"
      contains: "_fix_capitalization"
      min_lines: 300
  key_links:
    - from: "src/text_processor_enhanced.py"
      to: "self._fix_capitalization()"
      via: "process() method"
      pattern: "_fix_capitalization"
---

# Plan: Improve capitalization after punctuation

## Objective

Improve capitalization logic in EnhancedTextProcessor to properly capitalize after sentence-ending punctuation. Addresses POST-05 requirement for better capitalization.

**Purpose:** Current `_fix_capitalization()` method handles basic cases but misses edge cases like multiple spaces, punctuation variations, and interactions with proper nouns. Improved capitalization makes output more polished.

**Output:** Enhanced `_fix_capitalization()` method in `EnhancedTextProcessor` with robust handling of sentence endings, first letter, and proper noun interactions.

## Context

@.planning/phases/03-text-processing/03-CONTEXT.md
@.planning/phases/03-text-processing/03-RESEARCH.md
@src/text_processor_enhanced.py

Current implementation (lines 273-289):
- Basic first-letter capitalization
- Split on `.!\s+` pattern
- Capitalizes after sentence endings
- Simple but may miss edge cases

Dependencies:
- 03-01, 03-02: Foundation fixes (run before capitalization)
- 03-03, 03-04: Morphology and proper nouns (capitalization must respect these)

## Tasks

<task type="auto">
  <name>Task 1: Analyze current capitalization implementation</name>
  <files>src/text_processor_enhanced.py</files>
  <action>
    Read current _fix_capitalization() method (lines 273-289).
    Identify:
    1. What works (basic cases)
    2. What's missing (edge cases)
    3. Interactions with proper nouns (from 03-04)
    4. Punctuation variations (., !, ?, ..., !!, ??)

    Edge cases to handle:
    - Multiple spaces after punctuation
    - Punctuation without space ("word.Next")
    - Ellipsis (...) - should capitalize after
    - Quotation marks after punctuation
    - Parentheses
    - Numbers after punctuation (don't capitalize)
  </action>
  <verify>Current implementation analyzed, edge cases listed</verify>
  <done>Edge cases documented for improvement</done>
</task>

<task type="auto">
  <name>Task 2: Rewrite _fix_capitalization with improved logic</name>
  <files>src/text_processor_enhanced.py</files>
  <action>
    Rewrite _fix_capitalization() method with:

    1. First letter always capitalized (existing logic is fine)

    2. Sentence-ending punctuation patterns:
       - . ! ? followed by space or end of string
       - Handle multiple punctuation (!!, ??, ...)
       - Handle quotes/parens after punctuation

    3. Improved regex pattern:
       ```python
       def _fix_capitalization(self, text: str) -> str:
           if not text:
               return text

           # Ensure first letter is capitalized
           text = text[0].upper() + text[1:] if text else text

           # Capitalize after sentence endings
           # Pattern: punctuation followed by optional quotes/parens, then space, then lowercase letter
           pattern = r'([.!?]+)\s*([)"\']*)\s*([а-яa-z])'

           def replacer(match):
               return match.group(1) + ' ' + match.group(2) + ' ' + match.group(3).upper()

           text = re.sub(pattern, replacer, text)

           return text
       ```

    4. DON'T capitalize after numbers:
       - "Глава 1. начало" -> "Глава 1. Начало"
       - "2024. год" -> "2024. Год" (actually this is correct)

    5. Handle abbreviations (optional, defer if complex):
       - "т.е. слово" - don't capitalize after "т.е."
       - "напр. пример" - don't capitalize after "напр."
       - For Phase 3, basic handling is acceptable

    Preserve proper noun capitalization from 03-04.
  </action>
  <verify>Method handles sentence endings with various punctuation</verify>
  <done>Improved capitalization logic implemented</done>
</task>

<task type="auto">
  <name>Task 3: Add capitalization for common punctuation scenarios</name>
  <files>src/text_processor_enhanced.py</files>
  <action>
    Extend _fix_capitalization() to handle:

    1. Ellipsis (...):
       - "слово... другое" -> "Слово... Другое"
       - Treat as sentence ending

    2. Multiple punctuation (!!, ??, !?):
       - "Да!! конечно" -> "Да!! Конечно"
       - "Что?? нет" -> "Что?? Нет"

    3. Quotation marks after punctuation:
       - "слово."начало" -> "Слово." Начало"
       - "!вопрос" -> "! Вопрос"

    4. Parentheses:
       - "(как то) слово" -> "(как-то) Слово"

    Use regex patterns to match these scenarios.
  </action>
  <verify>Method handles ellipsis, multiple punctuation, quotes</verify>
  <done>Extended punctuation scenarios handled</done>
</task>

<task type="auto">
  <name>Task 4: Ensure capitalization doesn't break proper nouns</name>
  <files>src/text_processor_enhanced.py</files>
  <action>
    Verify that capitalization logic works with proper nouns from 03-04:

    1. If proper noun already capitalized, don't change it
    2. If proper noun at sentence start, ensure it's capitalized
    3. Don't lowercase any already-capitalized words

    Test cases:
    - "москва красивый город" -> "Москва красивый город"
    - "в москве красиво" -> "В Москве красиво"
    - "деннис сказал. привет" -> "Denis сказал. Привет"

    Processing order ensures proper nouns run last, so capitalization
    shouldn't interfere. Verify this is the case.
  </action>
  <verify>Capitalization doesn't interfere with proper nouns</verify>
  <done>Capitalization works correctly with proper nouns</done>
</task>

## Verification

1. First letter: "тест" -> "Тест"
2. After period: "слово. другое" -> "Слово. Другое"
3. After exclamation: "да! нет" -> "Да! Нет"
4. After question: "что? да" -> "Что? Да"
5. With ellipsis: "слова... и еще" -> "Слова... И еще"
6. With proper noun: "в москве" -> "В Москве" (after 03-04 integration)

## Success Criteria

- [ ] First letter always capitalized
- [ ] Capitalization after . ! ?
- [ ] Handles multiple punctuation (!!, ??)
- [ ] Handles ellipsis (...)
- [ ] Works with proper nouns (no interference)
- [ ] No regressions in existing capitalization

## Output

After completion, create `.planning/phases/03-text-processing/03-05-SUMMARY.md` with:
- Capitalization patterns implemented
- Edge cases handled
- Test cases passed
