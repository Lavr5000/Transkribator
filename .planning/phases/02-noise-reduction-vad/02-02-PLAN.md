---
phase: 02-noise-reduction-vad
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - src/audio_recorder.py
  - RemotePackage/src/audio_recorder.py
  - src/config.py
autonomous: true

must_haves:
  truths:
    - "Текущий 20x software gain (mic_boost=20.0) заменён на WebRTC AGC"
    - "AGC автоматически адаптирует уровень громкости к целевому -16 dBFS"
    - "Фиксированный mic_boost больше не применяется (остаётся только как fallback)"
    - "Gain адаптируется плавно без резких скачков звука"
  artifacts:
    - path: "src/audio_recorder.py"
      contains: "auto_gain_dbfs"
      contains: "# Apply software boost only if WebRTC not available"
    - path: "src/config.py"
      contains: "# mic_boost: float = 20.0  # DEPRECATED: Use WebRTC AGC instead"
  key_links:
    - from: "src/audio_recorder.stop"
      to: "WebRTC AGC"
      via: "skip mic_boost when webrtc_enabled"
      pattern: "if self.webrtc_enabled"
    - from: "src/audio_recorder.stop"
      to: "WebRTC AGC bypass"
      via: "conditional software boost prevents double-boosting"
      pattern: "if not self.webrtc_enabled and self.mic_boost != 1.0"
---

<objective>
Replace fixed 20x software gain with WebRTC Adaptive Gain Control (AGC).

**What:**
Remove mic_boost=20.0 software gain and use WebRTC AGC for automatic level normalization.

**Why:**
Fixed 20x gain can cause clipping on loud input and insufficient boost on quiet input. WebRTC AGC adapts to input level automatically, normalizing to -16 dBFS target without user intervention.

**Output:**
AudioRecorder with AGC handling gain adaptation, mic_boost deprecated, config updated.
</objective>

<execution_context>
@C:\Users\user\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\user\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-noise-reduction-vad/02-RESEARCH.md
@.planning/phases/02-noise-reduction-vad/02-01-SUMMARY.md

# Current file locations
C:\Users\user\.claude\0 ProEKTi\Transkribator\src\audio_recorder.py
C:\Users\user\.claude\0 ProEKTi\Transkribator\RemotePackage\src\audio_recorder.py
C:\Users\user\.claude\0 ProEKTi\Transkribator\src\config.py
</context>

<tasks>

<task type="auto">
  <name>Deprecate mic_boost in config</name>
  <files>src/config.py</files>
  <action>
Update mic_boost config field (line 30):

1. Change default from 20.0 to 1.0 (no boost by default):
2. Add deprecation comment:

```python
mic_boost: float = 1.0  # Software gain multiplier (DEPRECATED: Use WebRTC AGC instead)
                           # Only used when webrtc_enabled=False
                           # 1.0 = no boost, kept for fallback compatibility
```

DO NOT remove the field - it's still needed for fallback when WebRTC is unavailable.
  </action>
  <verify>grep -n "mic_boost.*DEPRECATED" src/config.py</verify>
  <done>mic_boost default changed to 1.0 with deprecation comment</done>
</task>

<task type="auto">
  <name>Update AudioRecorder to skip software boost when AGC enabled</name>
  <files>src/audio_recorder.py, RemotePackage/src/audio_recorder.py</files>
  <action>
In both audio_recorder.py files, modify the stop() method (line 124-173):

Find the software boost application section (around line 167-171):
```python
# Apply software boost if needed
if self.mic_boost != 1.0:
    audio = audio * self.mic_boost
    # Clip to prevent distortion
    audio = np.clip(audio, -1.0, 1.0)
```

Replace with AGC-aware version:
```python
# Apply software boost ONLY if WebRTC AGC is not available
# WebRTC AGC handles gain adaptation automatically
if not self.webrtc_enabled and self.mic_boost != 1.0:
    audio = audio * self.mic_boost
    # Clip to prevent distortion
    audio = np.clip(audio, -1.0, 1.0)
```

This ensures:
- WebRTC AGC gain is applied in real-time (in callback) - no post-processing needed
- Software boost only applies as fallback when WebRTC is unavailable
- No double-boosting (AGC + software boost would clip)
  </action>
  <verify>grep -A2 "Apply software boost" src/audio_recorder.py RemotePackage/src/audio_recorder.py | grep -n "not self.webrtc_enabled"</verify>
  <done>Software boost only applied when WebRTC is disabled</done>
</task>

<task type="auto">
  <name>Update AudioRecorder docstring for AGC behavior</name>
  <files>src/audio_recorder.py, RemotePackage/src/audio_recorder.py</files>
  <action>
In both audio_recorder.py files, update the class docstring (line 18-19):

From:
```python
class AudioRecorder:
    """Records audio from the microphone."""
```

To:
```python
class AudioRecorder:
    """Records audio from the microphone with WebRTC noise suppression and AGC.

    When webrtc_enabled=True (default):
    - WebRTC Noise Suppression removes background noise
    - WebRTC AGC normalizes audio to -16 dBFS target automatically
    - mic_boost parameter is ignored (AGC handles gain)

    When webrtc_enabled=False (fallback):
    - Raw audio capture with optional software mic_boost
    """
```

Also update __init__ docstring for mic_boost parameter:
```python
    def __init__(
        self,
        ...
        mic_boost: float = 1.0,  # Software gain (DEPRECATED - only used when webrtc_enabled=False)
        ...
    ):
```
  </action>
  <verify>grep -n "AGC normalizes\|DEPRECATED.*webrtc_enabled" src/audio_recorder.py RemotePackage/src/audio_recorder.py</verify>
  <done>Docstrings explain AGC behavior and mic_boost deprecation</done>
</task>

</tasks>

<verification>
After implementation:
1. grep confirms mic_boost default is 1.0 (not 20.0)
2. grep confirms DEPRECATED comment on mic_boost
3. grep confirms "not self.webrtc_enabled" condition before software boost
4. grep confirms AGC mentioned in class docstring
5. Changes synchronized between local and RemotePackage versions
</verification>

<success_criteria>
- [ ] mic_boost default changed from 20.0 to 1.0
- [ ] DEPRECATED comment explains WebRTC AGC replacement
- [ ] Software boost only applies when webrtc_enabled=False
- [ ] AGC gain applied in real-time (no post-processing needed)
- [ ] Class docstring documents AGC behavior
- [ ] Both local and RemotePackage versions updated
</success_criteria>

<output>
After completion, create `.planning/phases/02-noise-reduction-vad/02-02-SUMMARY.md`
</output>
