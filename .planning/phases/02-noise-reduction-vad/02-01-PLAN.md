---
phase: 02-noise-reduction-vad
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/audio_recorder.py
  - RemotePackage/src/audio_recorder.py
  - src/config.py
autonomous: true

must_haves:
  truths:
    - "AudioRecorder применяет WebRTC Noise Suppression в реальном времени (<10ms latency)"
    - "WebRTC обрабатывает 10ms блоки (160 samples at 16kHz)"
    - "Noise suppression работает с 16kHz mono audio"
    - "WebRTC обработка отключается с фоллбэком если библиотека недоступна (Windows compatibility)"
  artifacts:
    - path: "src/audio_recorder.py"
      contains: "from webrtc_noise_gain import AudioProcessor"
      contains: "_webrtc_processor"
      contains: "Process10ms"
    - path: "src/config.py"
      contains: "webrtc_enabled"
      contains: "noise_suppression_level"
  key_links:
    - from: "src/audio_recorder.py"
      to: "webrtc_noise_gain.AudioProcessor"
      via: "import with fallback"
      pattern: "try.*from webrtc_noise_gain"
    - from: "src/audio_recorder._audio_callback"
      to: "AudioProcessor.Process10ms"
      via: "int16 conversion"
      pattern: "Process10ms"
---

<objective>
Integrate WebRTC Noise Suppression into AudioRecorder for real-time noise reduction.

**What:**
Add WebRTC noise suppression to audio recording pipeline using webrtc-noise-gain library.

**Why:**
Background noise (fan, keyboard, ambient) degrades ASR accuracy by 5-15%. WebRTC NS is industry-standard for real-time noise suppression with minimal latency (<10ms).

**Output:**
AudioRecorder with WebRTC noise suppression integrated into audio callback, with Windows fallback support.
</objective>

<execution_context>
@C:\Users\user\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\user\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-noise-reduction-vad/02-RESEARCH.md
@.planning/codebase/ARCHITECTURE.md

# Current file locations
C:\Users\user\.claude\0 ProEKTi\Transkribator\src\audio_recorder.py
C:\Users\user\.claude\0 ProEKTi\Transkribator\RemotePackage\src\audio_recorder.py
C:\Users\user\.claude\0 ProEKTi\Transkribator\src\config.py
</context>

<tasks>

<task type="auto">
  <name>Add WebRTC Noise Suppression configuration</name>
  <files>src/config.py</files>
  <action>
Add WebRTC settings to Config dataclass after line 30 (after mic_boost):

```python
# WebRTC audio processing settings
webrtc_enabled: bool = True  # Enable WebRTC noise suppression and AGC
noise_suppression_level: int = 2  # 0-4: 0=off, 1=low, 2=moderate, 3=high, 4=very high
```

DO NOT change any other config parameters.
  </action>
  <verify>grep -n "webrtc_enabled\|noise_suppression_level" src/config.py</verify>
  <done>Config has webrtc_enabled=True and noise_suppression_level=2 (moderate)</done>
</task>

<task type="auto">
  <name>Integrate WebRTC AudioProcessor into AudioRecorder</name>
  <files>src/audio_recorder.py, RemotePackage/src/audio_recorder.py</files>
  <action>
In both audio_recorder.py files:

1. After line 16 (AUDIO_AVAILABLE check), add WebRTC import with fallback:
```python
# WebRTC noise suppression (optional - may not be available on all platforms)
_WEBRTC_AVAILABLE = False
try:
    from webrtc_noise_gain import AudioProcessor
    _WEBRTC_AVAILABLE = True
except (ImportError, OSError):
    pass  # WebRTC not available, will use software boost only
```

2. Update __init__ signature (line 21-28) - add webrtc_enabled and noise_suppression_level parameters:
```python
def __init__(
    self,
    sample_rate: int = 16000,
    channels: int = 1,
    on_level_update: Optional[Callable[[float], None]] = None,
    device: Optional[int] = None,
    mic_boost: float = 1.0,  # Software gain (deprecated, use AGC)
    webrtc_enabled: bool = True,
    noise_suppression_level: int = 2,
):
```

3. Store WebRTC parameters after line 33 (after self.mic_boost):
```python
self.webrtc_enabled = webrtc_enabled and _WEBRTC_AVAILABLE
self.noise_suppression_level = noise_suppression_level
self._webrtc_processor = None
```

4. Initialize WebRTC processor at end of __init__:
```python
# Initialize WebRTC processor if enabled
if self.webrtc_enabled:
    try:
        self._webrtc_processor = AudioProcessor(
            auto_gain_dbfs=3,  # Target -16 dBFS (will be configured in 02-02)
            noise_suppression_level=self.noise_suppression_level,
        )
    except Exception:
        self._webrtc_processor = None
        self.webrtc_enabled = False
```
  </action>
  <verify>grep -n "_WEBRTC_AVAILABLE\|webrtc_enabled\|_webrtc_processor" src/audio_recorder.py RemotePackage/src/audio_recorder.py</verify>
  <done>Both files have WebRTC import with fallback, processor initialization, and parameters stored</done>
</task>

<task type="auto">
  <name>Add WebRTC processing to audio callback</name>
  <files>src/audio_recorder.py, RemotePackage/src/audio_recorder.py</files>
  <action>
In both audio_recorder.py files, modify _audio_callback method (line 43-66):

Replace the existing callback with WebRTC-aware version:

```python
def _audio_callback(self, indata, frames, time_info, status):
    """Callback for audio stream - applies WebRTC noise suppression if enabled."""
    # Early exit if shutting down
    if self._shutting_down or not self._recording:
        return

    if status:
        print(f"Audio status: {status}")

    # Copy audio data
    data = indata.copy()

    # Apply WebRTC processing if enabled (real-time noise suppression)
    if self.webrtc_enabled and self._webrtc_processor is not None:
        try:
            # Convert float32 [-1, 1] to int16 PCM for WebRTC
            data_int16 = (data * 32767).astype(np.int16)

            # Process in 10ms chunks (160 samples @ 16kHz)
            # WebRTC requires exactly 10ms chunks at 16kHz
            chunk_size = 160  # 10ms @ 16kHz
            processed_chunks = []

            for i in range(0, len(data_int16), chunk_size):
                chunk = data_int16[i:i + chunk_size]
                if len(chunk) < chunk_size:
                    # Pad last chunk if needed
                    chunk = np.pad(chunk, (0, chunk_size - len(chunk)), mode='constant')

                # Process 10ms chunk
                result = self._webrtc_processor.Process10ms(chunk.tobytes())
                if result.audio:
                    processed_chunks.append(np.frombuffer(result.audio, dtype=np.int16))

            if processed_chunks:
                # Convert back to float32 and reshape
                data_int16 = np.concatenate(processed_chunks)
                data = data_int16.astype(np.float32) / 32767.0
                data = data.reshape(-1, 1)  # Ensure (samples, channels) shape
        except Exception as e:
            # Fallback to original data if WebRTC fails
            pass

    try:
        self._audio_queue.put_nowait(data)
    except queue.Full:
        pass  # Drop frame if queue is full

    # Calculate audio level for visualization (use cleaned audio)
    if self.on_level_update and not self._shutting_down:
        try:
            level = np.abs(data).mean()
            self.on_level_update(float(level))
        except Exception:
            pass  # Ignore errors in callback
```

DO NOT change any other methods.
  </action>
  <verify>grep -n "Process10ms\|data_int16\|32767" src/audio_recorder.py RemotePackage/src/audio_recorder.py</verify>
  <done>Audio callback applies WebRTC noise suppression to each 10ms chunk before queuing</done>
</task>

</tasks>

<verification>
After implementation:
1. grep confirms _WEBRTC_AVAILABLE check in both files
2. grep confirms webrtc_enabled and noise_suppression_level in __init__
3. grep confirms _webrtc_processor initialization
4. grep confirms Process10ms call in _audio_callback
5. Code handles WebRTC unavailability gracefully (try/except on import)
</verification>

<success_criteria>
- [ ] WebRTC AudioProcessor imported with fallback for unsupported platforms
- [ ] Config has webrtc_enabled and noise_suppression_level parameters
- [ ] AudioRecorder initializes WebRTC processor when enabled
- [ ] Audio callback processes audio in 10ms chunks (160 samples @ 16kHz)
- [ ] Float32 to int16 PCM conversion before WebRTC processing
- [ ] Processed audio converted back to float32 for downstream use
- [ ] Changes synchronized between local and RemotePackage versions
</success_criteria>

<output>
After completion, create `.planning/phases/02-noise-reduction-vad/02-01-SUMMARY.md`
</output>
