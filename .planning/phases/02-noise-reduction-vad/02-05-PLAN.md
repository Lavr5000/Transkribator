---
phase: 02-noise-reduction-vad
plan: 05
type: execute
wave: 3
depends_on: [02-03, 02-04]
files_modified:
  - src/main_window.py
autonomous: false

must_haves:
  truths:
    - "User can see VAD level bar indicator during recording"
    - "Цвет меняется: серый (тишина) -> синий (речь)"
    - "Индикатор обновляется в реальном времени во время записи"
  artifacts:
    - path: "src/main_window.py"
      contains: "vad_level_bar"
      contains: "_on_vad_level_update"
      contains: "QProgressBar"
  key_links:
    - from: "src/audio_recorder.on_level_update"
      to: "MainWindow._on_vad_level_update"
      via: "callback registration"
      pattern: "on_level_update.*=.*self._on_vad_level_update"
    - from: "MainWindow._on_vad_level_update"
      to: "vad_level_bar.setValue"
      via: "Qt signal/slot or direct call"
      pattern: "setValue"
---

<objective>
Add VAD visualization to MainWindow UI for real-time speech detection feedback.

**What:**
Add a VAD level bar (QProgressBar) that shows speech detection activity during recording - gray for silence, blue for speech.

**Why:**
User needs visual feedback that speech is being detected. Current implementation has basic level indicator but doesn't clearly distinguish speech from silence. VAD visualization helps user know when they're being recorded correctly.

**Output:**
MainWindow with VAD level bar indicator showing real-time speech detection state with color changes (gray -> blue).
</objective>

<execution_context>
@C:\Users\user\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\user\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-noise-reduction-vad/02-CONTEXT.md
@.planning/phases/02-noise-reduction-vad/02-03-SUMMARY.md
@.planning/phases/02-noise-reduction-vad/02-04-SUMMARY.md
@.planning/codebase/ARCHITECTURE.md

# Current file locations
C:\Users\user\.claude\0 ProEKTi\Transkribator\src\main_window.py
C:\Users\user\.claude\0 ProEKTi\Transkribator\src\audio_recorder.py
</context>

<tasks>

<task type="auto">
  <name>Add VAD level bar widget to MainWindow UI</name>
  <files>src/main_window.py</files>
  <action>
In main_window.py:

1. Add import if not present (QProgressBar):
```python
from PyQt6.QtWidgets import (
    QMainWindow, QWidget, QVBoxLayout, QHBoxLayout,
    QPushButton, QLabel, QTextEdit, QSystemTrayIcon, QMenu,
    QProgressBar,  # Add this
    # ... other imports
)
```

2. In MainWindow.__init__ (around line 50-100), after the existing UI elements are created, add VAD level bar:
```python
# Create VAD level bar for speech detection visualization
self.vad_level_bar = QProgressBar()
self.vad_level_bar.setRange(0, 100)  # 0-100%
self.vad_level_bar.setTextVisible(False)
self.vad_level_bar.setMaximumHeight(8)  # Thin bar
self.vad_level_bar.setMinimumWidth(200)

# Initial style: Gray (silence)
self.vad_level_bar.setStyleSheet("""
    QProgressBar { border: none; background-color: #374151; }
    QProgressBar::chunk { background-color: #6b7280; }
""")

# Add VAD level bar to layout (find the layout containing recording controls)
# This is typically in the main vertical layout or the button row
# Look for where record_button is added and add VAD bar nearby
```

3. Find where the main layout is created (look for `layout = QVBoxLayout()` or similar) and add the VAD bar:
```python
# Add VAD level bar below the record button
layout.addWidget(self.vad_level_bar)
```

Position the VAD bar logically - it should be visible during recording, near the recording controls.
  </action>
  <verify>grep -n "vad_level_bar\|QProgressBar" src/main_window.py</verify>
  <done>VAD level bar widget created and added to layout</done>
</task>

<task type="auto">
  <name>Connect AudioRecorder level callback to VAD bar update</name>
  <files>src/main_window.py</files>
  <action>
In main_window.py:

1. Find where AudioRecorder is instantiated (look for `self.audio_recorder = AudioRecorder(...)`)
   This is typically in __init__ around line 70-100

2. Update the AudioRecorder instantiation to include the level callback:
```python
self.audio_recorder = AudioRecorder(
    sample_rate=config.sample_rate,
    channels=config.channels,
    on_level_update=self._on_vad_level_update,  # Add this callback
    device=config.audio_device,
    mic_boost=config.mic_boost,
    webrtc_enabled=config.webrtc_enabled,
    noise_suppression_level=config.noise_suppression_level,
)
```

3. Add the callback method to MainWindow class (add near other callback methods):
```python
def _on_vad_level_update(self, level: float):
    """Update VAD level bar based on audio level (speech detection).

    Args:
        level: Audio level from 0.0 (silence) to 1.0 (loud speech)
    """
    # Convert level to percentage (0-100)
    percentage = min(100, int(level * 100))

    # Update the level bar
    self.vad_level_bar.setValue(percentage)

    # Change color based on speech detection
    # Threshold: >10% considered speech (adjust based on testing)
    if percentage > 10:
        # Speech detected - Blue
        self.vad_level_bar.setStyleSheet("""
            QProgressBar { border: none; background-color: #374151; }
            QProgressBar::chunk { background-color: #3b82f6; }
        """)
    else:
        # Silence - Gray
        self.vad_level_bar.setStyleSheet("""
            QProgressBar { border: none; background-color: #374151; }
            QProgressBar::chunk { background-color: #6b7280; }
        """)
```
  </action>
  <verify>grep -n "_on_vad_level_update\|on_level_update=self._on_vad_level_update" src/main_window.py</verify>
  <done>AudioRecorder level callback connected to VAD bar update method</done>
</task>

<task type="auto">
  <name>Reset VAD level bar when recording starts/stops</name>
  <files>src/main_window.py</files>
  <action>
In main_window.py:

1. Find the _start method (called when recording starts) and add VAD bar reset:
```python
def _start(self):
    """Start recording."""
    # ... existing start code ...

    # Reset VAD level bar to silence state
    self.vad_level_bar.setValue(0)
    self.vad_level_bar.setStyleSheet("""
        QProgressBar { border: none; background-color: #374151; }
        QProgressBar::chunk { background-color: #6b7280; }
    """)

    # ... rest of start code ...
```

2. Find the _done or _stop method (called when recording stops) and add VAD bar reset:
```python
def _done(self, text: str):
    """Called when transcription is complete."""
    # Reset VAD level bar to silence state
    self.vad_level_bar.setValue(0)
    self.vad_level_bar.setStyleSheet("""
        QProgressBar { border: none; background-color: #374151; }
        QProgressBar::chunk { background-color: #6b7280; }
    """)

    # ... existing done code ...
```

This ensures the VAD bar doesn't remain "stuck" in speech state after recording ends.
  </action>
  <verify>grep -B2 -A2 "vad_level_bar.setValue(0)" src/main_window.py</verify>
  <done>VAD level bar resets to silence state on record start/stop</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>VAD level bar in MainWindow with real-time speech detection visualization</what-built>
  <how-to-verify>
1. Запустите приложение: `python main.py`
2. Нажмите кнопку записи (или Ctrl+Shift+Space)
3. Произнесите текст в микрофон
4. Наблюдайте за VAD level bar:

Ожидаемое поведение:
- Полоса серого цвета в состоянии покоя (тишина)
- Полоза становится синей когда вы говорите
- Длина полосы отражает громкость речи
- Полоза сбрасывается в серое состояние после остановки записи

5. Проверьте запись тихого звука - полоза должна быть серой
6. Проверте запись громкой речи - полоза должна стать синей
  </how-to-verify>
  <resume-signal>Type "approved" if VAD level bar works correctly, or describe issues</resume-signal>
</task>

</tasks>

<verification>
After implementation:
1. grep confirms vad_level_bar widget creation
2. grep confirms _on_vad_level_update callback method
3. grep confirms on_level_update connected to AudioRecorder
4. grep confirms color change logic (blue for speech, gray for silence)
5. grep confirms VAD bar reset on start/stop
6. User verification confirms visual behavior matches expectations
</verification>

<success_criteria>
- [ ] VAD level bar widget added to MainWindow UI
- [ ] Callback connects AudioRecorder level to VAD bar updates
- [ ] Color changes from gray (silence) to blue (speech)
- [ ] Level bar shows audio intensity (0-100%)
- [ ] VAD bar resets when recording starts/stops
- [ ] User verified visual behavior during recording
</success_criteria>

<output>
After completion, create `.planning/phases/02-noise-reduction-vad/02-05-SUMMARY.md`
</output>
