# Performance Diagnostic Report

## Проблема
Транскрибация на удалённом сервере работает **категорически медленно**.

## Диагностика потока данных

### Текущий поток
```
1. Клиент записывает аудио (numpy array)
2. Сохранение в temporary WAV файл (remote_client.py:141-161)
3. HTTP POST upload файла (remote_client.py:180-186)
4. Сервер сохраняет файл и транскрибирует (server.py)
5. Polling статуса каждые 2 секунды (remote_client.py:204)
6. HTTP GET download результата (remote_client.py:238)
```

### Временные затраты (оценка)

| Этап | Время | Примечание |
|------|-------|------------|
| Запись аудио | 5-30 сек | Зависит от пользователя |
| Сохранение WAV | <0.5 сек | Локально |
| **Upload файла** | **5-30 сек** | **ЗАВИСИТ ОТ РАЗМЕРА ФАЙЛА!** |
| Транскрибация | 2-10 сек | Зависит от модели |
| Polling (avg) | 1 сек | check_interval=2s |
| Download результата | <0.5 сек | Текст небольшой |
| **ИТОГО** | **15-50 сек** | **Большая часть - upload!** |

## Узкие места

### 1. WAV формат без сжатия ⚠️ КРИТИЧНО
```python
# remote_client.py:158
sf.write(path, audio, sample_rate)  # Сохраняет как WAV без сжатия
```

**Проблема:** WAV = большие файлы
- 16kHz, 16-bit, mono = ~32 KB/sec
- 30 сек записи = ~960 KB
- 5 мин записи = ~9.6 MB

**Решение:** Использовать Opus или FLAC (сжатие без потери качества)

### 2. Полный upload вместо streaming
```python
# remote_client.py:182
files={"file": f}  # Загружает весь файл целиком
```

**Проблема:** Клиент ждёт окончания upload перед получением task_id

**Решение:** Streaming upload или chunked transfer encoding

### 3. Медленный polling
```python
# remote_client.py:204
check_interval = 2.0  # seconds
```

**Проблема:** Добавляет среднюю задержку 1 секунду

**Решение:** Уменьшить до 0.5 сек или использовать WebSocket/SSE

### 4. Старые параметры на сервере
```python
# TranscriberServer/transcriber_wrapper.py:35-40
self.transcriber = Transcriber(
    backend="whisper",      # Медленнее чем Sherpa
    model_size="base",      # Не оптимизирован
    language="auto",        # Лишние вычисления автоопределения
)
```

**Проблема:** Не использует Phase 1-4 улучшения

**Решение:** Обновить до:
- backend="sherpa" (10x быстрее для русского)
- model_size="giga-am-v2-ru" (специализирован)
- language="ru" (без автоопределения)
- vad_enabled=True (удаление тишины)

### 5. Отсутствие VAD фильтрации на входе
**Проблема:** Весь файл транскрибируется включая тишину

**Решение:** VAD на клиенте ДО отправки = меньше данных

## Метрики для измерения

Для точной диагностики нужно добавить логирование времени:

```python
# В remote_client.py
upload_start = time.time()
# ... upload ...
upload_time = time.time() - upload_start
logger.info(f"Upload took {upload_time:.2f}s for {wav_path.stat().st_size / 1024:.1f} KB")
```

## Приоритеты оптимизации

| # | Оптимизация | Улучшение скорости | Сложность |
|---|-------------|-------------------|-----------|
| 1 | Opus сжатие аудио | 5-10x (upload) | Средняя |
| 2 | Обновить параметры сервера | 2-5x (transcription) | Легкая |
| 3 | VAD на клиенте | 2-3x (меньше данных) | Средняя |
| 4 | Streaming upload | 1-2x | Сложная |
| 5 | Быстрый polling | 0-2 сек | Легкая |

## Рекомендации

### Минимум (быстрый фикс)
1. Обновить `transcriber_wrapper.py` с правильными параметрами
2. Добавить логирование времени для точной диагностики
3. Уменьшить check_interval до 0.5 сек

### Оптимум
1. Всё из "Минимум" +
2. Добавить Opus кодирование
3. Включить VAD на клиенте

### Идеал
1. Всё из "Оптимум" +
2. Реализовать streaming upload
3. WebSocket вместо polling
