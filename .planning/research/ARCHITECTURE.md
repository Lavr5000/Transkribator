# Architecture Diagnostic Report

## Текущая архитектура Transkribator (удалённый режим)

```
┌─────────────────┐
│  Клиент (ПК)    │
│  main_window.py │
└────────┬────────┘
         │
         ▼
┌─────────────────────────┐
│  AudioRecorder          │
│  - Запись аудио         │
│  - WebRTC Noise/Gain    │
│  - VAD (опционально)    │
└────────┬────────────────┘
         │ numpy array (16kHz, mono)
         ▼
┌─────────────────────────┐
│  HybridTranscriptionThread│
│  - Проверка health server│
│  - Fallback на локальный │
└────────┬────────────────┘
         │
         ├─────────────────┬──────────────────┐
         ▼                 ▼                  ▼
┌────────────────┐  ┌──────────────┐  ┌─────────────┐
│Remote Client   │  │  Локальный   │  │   (другие)  │
│remote_client.py│  │ Transcriber  │  │             │
└───────┬────────┘  └──────────────┘  └─────────────┘
        │
        ▼
┌─────────────────────────┐
│  _save_temp_wav()       │
│  - soundfile.write()    │
│  - Создаёт временный WAV│
└────────┬────────────────┘
         │ WAV файл (больший размер!)
         ▼
┌─────────────────────────┐
│  _upload_and_wait()     │
│  - HTTP POST /transcribe│
│  - Polling /status      │
│  - HTTP GET /result     │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────┐
│  Сеть (Интернет/Tailscale)│
│  - Upload latency       │
│  - Download latency     │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────┐
│  Удалённый сервер       │
│  server.py              │
│  FastAPI                │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────┐
│  transcriber_wrapper.py │
│  Transcriber(           │
│    backend=whisper,     │ ← СТАРЫЕ ПАРАМЕТРЫ!
│    model_size=base,     │
│    language=auto)       │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────┐
│  WhisperBackend         │
│  - faster-whisper       │
│  - Transcribe           │
└────────┬────────────────┘
         │
         ▼
    Текст результата
```

## Где добавляется задержка

| Компонент | Задержка | Причина |
|-----------|----------|---------|
| AudioRecorder | 0-30 сек | Время записи пользователя |
| **_save_temp_wav** | **0.2-0.5 сек** | Создание WAV файла |
| **Upload (HTTP POST)** | **5-30 сек** | **Размер WAV файла!** |
| Сеть | 10-100 мс | Tailscale/Internet |
| **Server processing** | **2-10 сек** | **Транскрибация** |
| Polling delay | 0-2 сек | check_interval=2s |
| Download | <100 мс | Текст небольшой |

## Ключевые проблемы

### 1. WAV формат на upload
**Проблема:** WAV без сжатия = большие файлы

**Расчёт размера:**
```
Размер = sample_rate × channels × bytes_per_sample × duration
       = 16000 × 1 × 2 × duration
       = 32000 bytes/sec ≈ 32 KB/sec
```

30 секунд записи = ~960 KB
5 минут записи = ~9.6 MB

**Upload время (при 1 Mbps):**
- 30 сек = ~8 сек upload
- 5 мин = ~80 сек upload

### 2. Полный upload перед обработкой
**Проблема:** Сервер не начинает обработку пока не получит весь файл

**Текущий:** POST с multipart/form-data, блокирует直到 complete

**Оптимально:** Streaming upload - сервер начинает обрабатывать как только получает первые данные

### 3. Polling вместо realtime
**Проблема:** Клиент проверяет статус каждые 2 секунды

**Текущий:** Средняя задержка = 1 сек (если повезёт) или 2 сек

**Оптимально:** WebSocket или Server-Sent Events (SSE)

## Рекомендации по архитектуре

### Краткосрочные (быстрые wins)
1. Обновить `transcriber_wrapper.py` с правильными параметрами
2. Добавить Opus кодирование на клиенте
3. Уменьшить check_interval до 0.5 сек

### Среднесрочные
1. VAD на клиенте - отрезать тишину ДО отправки
2. WebSocket для realtime статуса
3. Chunked upload для параллельной записи и передачи

### Долгосрочные
1. Полный streaming pipeline (запись → кодирование → upload → транскрибация одновременно)
2. WebRTC streaming аудио напрямую на сервер
3. Edge-side обработка на сервере (ближе к клиенту)
