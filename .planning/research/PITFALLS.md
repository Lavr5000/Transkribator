# Pitfalls - Типичные проблемы с удалённой транскрибацией

## 1. Большой размер аудио файлов ⚠️ КРИТИЧНО

**Симптомы:**
- Upload занимает больше времени чем транскрибация
- Пользователь ждёт 10-30+ секунд после окончания записи

**Диагностика:**
```python
import os
wav_size = os.path.getsize(wav_path) / 1024  # KB
print(f"File size: {wav_size:.1f} KB")
```

Если > 500 KB для 30 сек записи - проблема в формате/кодировании.

**Решение:**
- Использовать Opus кодирование (~10x сжатие)
- Или FLAC (~2x сжатие, lossless)
- ИЛИ уменьшить sample_rate до 8000 Hz

**Код:**
```python
# Вместо soundfile.write(..., wav)
import pyogg
# Opus encoding дает ~10x сжатие
```

## 2. Неоптимальные параметры моделей ⚠️ КРИТИЧНО

**Симптомы:**
- Транскрибация на сервере медленная (5-10+ сек для 30 сек аудио)
- Качество распознавания низкое для русского

**Диагностика:**
Проверить `TranscriberServer/transcriber_wrapper.py`:
```bash
grep -A5 "Transcriber(" transcriber_wrapper.py
```

Если видишь `language="auto"` или `backend="whisper"` - ПРОБЛЕМА!

**Решение:**
```python
self.transcriber = Transcriber(
    backend="sherpa",           # 10x быстрее
    model_size="giga-am-v2-ru", # Для русского
    language="ru",              # Принудительно
    vad_enabled=True,            # Удалить тишину
)
```

## 3. Отсутствие VAD на входе

**Симптомы:**
- Транскрибация включает паузы/тишину
- Обработка идёт дольше чем нужно

**Диагностика:**
Проверить длину аудио vs длину текста. Если аудио 60 сек но текст только 20 сек - VAD не работает.

**Решение:**
- Включить VAD на клиенте (AudioRecorder)
- Или на сервере перед транскрибацией

## 4. Медленный polling

**Симптомы:**
- Пользователь видит задержку после "записи завершено"

**Диагностика:**
Проверить `remote_client.py:204`:
```python
check_interval = 2.0  # Секунды между проверками
```

**Решение:**
```python
check_interval = 0.5  # Более частые проверки
# Или использовать WebSocket/SSE
```

## 5. Нет логирования времени

**Симптомы:**
- Не понятно где именно тормозит

**Решение:**
Добавить logging в critical points:
```python
logger.info(f"Upload took {upload_time:.2f}s for {file_size/1024:.1f}KB")
logger.info(f"Transcription took {transcribe_time:.2f}s")
```

## 6. Проблемы с Tailscale/VPN

**Симптомы:**
- Connect timed out
- Server health check fails

**Диагностика:**
```python
# Check if Tailscale IP is reachable
ping 100.102.178.110
```

**Решение:**
- Проверить что Tailscale запущен
- Проверить firewall на сервере
- Использовать serveo.net fallback

## 7. Параметры quality не синхронизированы

**Симптомы:**
- Локальная транскрибация хорошая, удалённая плохая

**Диагностика:**
Сравнить `src/config.py` (локальный) vs `TranscriberServer/transcriber_wrapper.py` (серверный)

**Решение:**
Синхронизировать параметры или использовать общий config файл

## 8. Отсутствие fallback

**Симптомы:**
- Если сервер недоступен - ошибка вместо локальной транскрибации

**Решение:**
Убедиться что `HybridTranscriptionThread` работает корректно

## Приоритет исправлений

| Приоритет | Проблема | Быстрый фикс |
|----------|----------|-------------|
| 1 | Параметры сервера | Обновить transcriber_wrapper.py |
| 2 | Размер файлов | Opus кодирование |
| 3 | VAD | Включить на клиенте |
| 4 | Polling | Уменьшить интервал |
| 5 | Логирование | Добавить timestamp logging |
