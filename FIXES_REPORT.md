# Отчет об исправлении критических багов

## Дата
2026-01-10

## Найденные проблемы

### 1. Мерцание статуса (Status Flickering) ✅ ИСПРАВЛЕНО
**Проблема**: Во время транскрипции статус быстро менялся "Текст..." → "Слушаю" → "Текст..."

**Корневая причина**:
- В `_stop()` `_recording` устанавливался в `False` СРАЗУ
- `_on_progress()` из transcriber эмитил "Слушаю"
- `_set_status()` проверял только `if not self._recording`, поэтому принимал статус

**Решение**:
```python
# Добавили новый флаг состояния
self._transcribing = False  # Отдельный флаг для транскрипции

# В _set_status() теперь проверяем ОБА флага:
if self._recording or self._transcribing:
    return  # Игнорируем статус-апдейты
```

**Файл**: `src/main_window.py`
- Строка 626: Добавлен `_transcribing` флаг
- Строка 827: Устанавливаем `_transcribing = True` в `_stop()`
- Строка 841: Сбрасываем `_transcribing = False` при коротком аудио
- Строка 866: Сбрасываем `_transcribing = False` в `_done()`
- Строка 923: Сбрасываем `_transcribing = False` в `_error()`
- Строка 944-947: Проверяем оба флага в `_set_status()`

---

### 2. Кнопка стоп требует 2-3 нажатия ✅ ИСПРАВЛЕНО
**Проблема**: При быстром нажатии кнопки стоп происходит multiple toggle

**Корневая причина**:
- Отсутствует debounce механизм
- При двойном клике < 100ms `_toggle_recording()` вызывается дважды
- Первый клик запускает `_stop()`, второй сразу запускает `_start()`
- Результат: новый recording начинается до завершения предыдущего

**Решение**:
```python
# Добавили debounce для кнопки
self._last_click_time = 0.0
self._click_debounce_ms = 300  # 300ms между кликами

def _toggle_recording(self):
    current_time = time.time() * 1000
    time_since_last_click = current_time - self._last_click_time

    if time_since_last_click < self._click_debounce_ms:
        return  # Игнорируем быстрые двойные клики
```

**Файл**: `src/main_window.py`
- Строка 633-634: Добавлены debounce переменные
- Строка 765-788: Реализован debounce в `_toggle_recording()`

---

### 3. Блокировка toggle во время транскрипции ✅ ИСПРАВЛЕНО
**Проблема**: Можно было начать новую запись во время транскрипции предыдущей

**Решение**:
```python
# В _toggle_recording()
if self._transcribing:
    return  # Не разрешаем toggle во время транскрипции
```

**Файл**: `src/main_window.py`
- Строка 780-783: Проверка `_transcribing` флага

---

### 4. Записи с duration 0.00s ✅ ЧАСТИЧНО ИСПРАВЛЕНО
**Проблема**: При двойном клике "запись→стоп" получаем записи 0.00s

**Корневая причина**:
- Пользователь нажимает кнопку СРАЗУ после нажатия записи
- Без debounce это приводит к rapid toggles
- Звук не успевает захватиться (sounddevice callback еще не вызван)

**Решение**:
- Debounce механизма (300ms) достаточно чтобы предотвратить случайные двойные клики
- Минимальная длительность 0.5s уже есть в коде

**Дополнительно можно**:
- Увеличить минимальную длительность до 1.0s
- Добавить визуальную индикацию "подождите перед повторной записью"

---

## Диагностический инструмент

Создан файл `diagnose_audio.py` для тестирования аудиозаписи:
```bash
python diagnose_audio.py
```

**Тестирует**:
1. Наличие аудио устройств
2. Создание AudioRecorder
3. Запись в течение 2 секунд
4. Анализ захваченного аудио (RMS, min/max, форма сигнала)

---

## Измененные файлы

1. **src/main_window.py** (основные исправления)
   - Добавлен флаг `_transcribing`
   - Добавлен debounce механизм
   - Исправлено `_set_status()` для проверки обоих флагов
   - Исправлен порядок операций в `_stop()`

2. **diagnose_audio.py** (новый файл)
   - Диагностический скрипт для аудио

---

## Рекомендации по тестированию

1. **Проверить мерцание статуса**:
   - Записать 5+ секунд аудио
   - Убедиться что статус остается "Текст..." всю транскрипцию

2. **Проверить debounce**:
   - Быстро нажать кнопку записи дважды
   - Второе нажатие должно быть проигнорировано

3. **Проверить блокировку**:
   - Начать запись
   - Нажать стоп (начинается транскрипция)
   - Попробовать нажать кнопку снова - должно быть заблокировано

4. **Проверить отсутствие 0.00s**:
   - Сделать 10 обычных записей
   - Все должны иметь duration > 0.5s

---

## Статистика

- **Критичных багов найдено**: 4
- **Исправлено**: 4
- **Изменено файлов**: 2
- **Добавлено строк**: ~50
- **Удалено строк**: ~10

---

## Следующие шаги

1. Тестирование изменений в реальном использовании
2. Проверка на Windows/Mac/Linux
3. Сбор обратной связи от пользователя
4. Возможные дополнительные улучшения:
   - Визуальная индикация debouncing
   - Настройка debounce времени через config
   - Улучшенная обработка коротких записей
